<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Reply - Mail Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1a1a',
                            card: '#2d2d2d',
                            border: '#404040',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-dark-bg min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-dark-card shadow-lg h-screen sticky top-0">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Mail Admin</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{email}}</p>
            </div>
            <nav class="mt-6">
                <a href="/admin/dashboard" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-bg">
                    üìä Dashboard
                </a>
                <a href="/admin/users" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-bg">
                    üë• Users
                </a>
                <a href="/admin/templates" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-bg">
                    üìù Email Templates
                </a>
                <a href="/admin/auto-reply" class="block px-6 py-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 border-r-4 border-blue-600">
                    üîÑ Auto-Reply
                </a>
                <a href="/chat/app"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üí¨</span>
                    <span class="font-medium">Email Chat</span>
                </a>
                <a href="/admin/security"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üõ°Ô∏è</span>
                    <span class="font-medium">Security</span>
                </a>
                <a href="/admin/mfa"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üîê</span>
                    <span class="font-medium">MFA/2FA</span>
                </a>
                <a href="/admin/sieve"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üìã</span>
                    <span class="font-medium">Sieve Rules</span>
                </a>
                <a href="/admin/search"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üîç</span>
                    <span class="font-medium">Full-text Search</span>
                </a>
                <a href="/admin/spam"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üö´</span>
                    <span class="font-medium">Spam Scoring</span>
                </a>
                <a href="/admin/greylisting"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üö¶</span>
                    <span class="font-medium">Greylisting</span>
                </a>
                <a href="/admin/quotas"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üìä</span>
                    <span class="font-medium">Quotas</span>
                </a>
                <a href="/admin/dns" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-bg">
                    üåê DNS Config
                </a>
                <a href="/admin/diagnostics" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-bg">
                    üîç Diagnostics
                </a>
                <a href="/admin/monitoring"
                   class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-xl">üìà</span>
                    <span class="font-medium">Monitoring</span>
                </a>
                <a href="/admin/backups" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-bg">
                    üíæ Backups
                </a>
                <a href="/admin/ssl" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-bg">
                    üîí SSL Certificates
                </a>
                <a href="/admin/settings" class="block px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-bg">
                    ‚öôÔ∏è Settings
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">üîÑ Auto-Reply / Vacation Responder</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">Configure automatic responses when you're away</p>
                    </div>
                    <div id="status-indicator" class="px-4 py-2 rounded-lg font-semibold hidden">
                        <!-- Filled dynamically -->
                    </div>
                </div>

                <!-- Configuration Form -->
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6">
                    <form id="auto-reply-form">
                        <!-- Enable/Disable Toggle -->
                        <div class="mb-6">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="is-active" class="sr-only peer">
                                <div class="relative w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                <span class="ml-3 text-lg font-medium text-gray-900 dark:text-gray-300">Enable Auto-Reply</span>
                            </label>
                        </div>

                        <!-- Date Range -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Start Date (optional)
                                </label>
                                <input type="datetime-local" id="start-date"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-dark-border rounded-lg bg-white dark:bg-dark-bg text-gray-900 dark:text-white">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Leave empty to start immediately</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    End Date (optional)
                                </label>
                                <input type="datetime-local" id="end-date"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-dark-border rounded-lg bg-white dark:bg-dark-bg text-gray-900 dark:text-white">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Leave empty for no end date</p>
                            </div>
                        </div>

                        <!-- Reply Interval -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Reply Interval (hours)
                            </label>
                            <input type="number" id="reply-interval" value="24" min="1" max="168"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-dark-border rounded-lg bg-white dark:bg-dark-bg text-gray-900 dark:text-white">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Minimum time before sending another auto-reply to the same sender</p>
                        </div>

                        <!-- Subject -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Subject
                            </label>
                            <input type="text" id="subject" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-dark-border rounded-lg bg-white dark:bg-dark-bg text-gray-900 dark:text-white"
                                placeholder="Out of Office">
                        </div>

                        <!-- HTML Body -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                HTML Message
                            </label>
                            <textarea id="body-html" required rows="8"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-dark-border rounded-lg bg-white dark:bg-dark-bg text-gray-900 dark:text-white font-mono text-sm"
                                placeholder="<p>Thank you for your email. I'm currently out of office and will respond when I return.</p>"></textarea>
                        </div>

                        <!-- Plain Text Body -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Plain Text Message
                            </label>
                            <textarea id="body-text" required rows="6"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-dark-border rounded-lg bg-white dark:bg-dark-bg text-gray-900 dark:text-white font-mono text-sm"
                                placeholder="Thank you for your email. I'm currently out of office and will respond when I return."></textarea>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-between items-center">
                            <button type="button" id="delete-btn" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition hidden">
                                Delete Configuration
                            </button>
                            <div class="flex gap-3 ml-auto">
                                <button type="button" id="cancel-btn" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                                    Cancel
                                </button>
                                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    Save Configuration
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Preview Section -->
                <div class="mt-8 bg-white dark:bg-dark-card rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Preview</h3>
                    <div class="border border-gray-300 dark:border-dark-border rounded-lg p-4 bg-gray-50 dark:bg-dark-bg">
                        <div class="mb-2">
                            <span class="font-semibold text-gray-700 dark:text-gray-300">Subject:</span>
                            <span id="preview-subject" class="text-gray-600 dark:text-gray-400 ml-2">-</span>
                        </div>
                        <hr class="my-3 border-gray-300 dark:border-dark-border">
                        <div id="preview-body" class="text-gray-700 dark:text-gray-300">
                            <em>Enter a message above to see a preview</em>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentConfig = null;

        // Load configuration on page load
        async function loadConfig() {
            try {
                const response = await fetch('/api/auto-reply');
                if (response.ok) {
                    currentConfig = await response.json();
                    if (currentConfig) {
                        populateForm(currentConfig);
                        document.getElementById('delete-btn').classList.remove('hidden');
                        updateStatusIndicator(currentConfig.is_active);
                    }
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        function populateForm(config) {
            document.getElementById('is-active').checked = config.is_active;
            document.getElementById('subject').value = config.subject;
            document.getElementById('body-html').value = config.body_html;
            document.getElementById('body-text').value = config.body_text;
            document.getElementById('reply-interval').value = config.reply_interval_hours;

            if (config.start_date) {
                document.getElementById('start-date').value = new Date(config.start_date).toISOString().slice(0, 16);
            }
            if (config.end_date) {
                document.getElementById('end-date').value = new Date(config.end_date).toISOString().slice(0, 16);
            }

            updatePreview();
        }

        function updateStatusIndicator(isActive) {
            const indicator = document.getElementById('status-indicator');
            indicator.classList.remove('hidden');
            if (isActive) {
                indicator.className = 'px-4 py-2 rounded-lg font-semibold bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400';
                indicator.textContent = '‚úì Active';
            } else {
                indicator.className = 'px-4 py-2 rounded-lg font-semibold bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400';
                indicator.textContent = '‚óã Inactive';
            }
        }

        function updatePreview() {
            const subject = document.getElementById('subject').value;
            const bodyHtml = document.getElementById('body-html').value;

            document.getElementById('preview-subject').textContent = subject || '-';
            document.getElementById('preview-body').innerHTML = bodyHtml || '<em>Enter a message above to see a preview</em>';
        }

        // Form submission
        document.getElementById('auto-reply-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                is_active: document.getElementById('is-active').checked,
                subject: document.getElementById('subject').value,
                body_html: document.getElementById('body-html').value,
                body_text: document.getElementById('body-text').value,
                reply_interval_hours: parseInt(document.getElementById('reply-interval').value),
                start_date: document.getElementById('start-date').value ? new Date(document.getElementById('start-date').value).toISOString() : null,
                end_date: document.getElementById('end-date').value ? new Date(document.getElementById('end-date').value).toISOString() : null,
            };

            try {
                const response = await fetch('/api/auto-reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Auto-reply configuration saved successfully!');
                    loadConfig();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                alert('Failed to save configuration: ' + error.message);
            }
        });

        // Delete configuration
        document.getElementById('delete-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete your auto-reply configuration?')) {
                return;
            }

            try {
                const response = await fetch('/api/auto-reply', { method: 'DELETE' });
                if (response.ok) {
                    alert('Auto-reply configuration deleted');
                    location.reload();
                } else {
                    alert('Failed to delete configuration');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Cancel button
        document.getElementById('cancel-btn').addEventListener('click', () => {
            if (currentConfig) {
                populateForm(currentConfig);
            } else {
                location.reload();
            }
        });

        // Live preview
        document.getElementById('subject').addEventListener('input', updatePreview);
        document.getElementById('body-html').addEventListener('input', updatePreview);

        // Load on page load
        loadConfig();
    </script>
</body>
</html>
