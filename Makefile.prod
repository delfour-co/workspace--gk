# =============================================================================
# GK Mail - Production Makefile
# =============================================================================
# Enhanced Makefile with production operations, secrets management, health
# checks, backups, and monitoring
# =============================================================================

.PHONY: help

# Colors
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m # No Color

# Configuration
COMPOSE_FILE := docker-compose.prod.yml
COMPOSE := docker compose -f $(COMPOSE_FILE)
VERSION := $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")

# =============================================================================
# Help
# =============================================================================

help:
	@echo "$(GREEN)GK Mail - Production Operations$(NC)"
	@echo ""
	@echo "$(YELLOW)Setup:$(NC)"
	@echo "  make init               - Initialize production environment"
	@echo "  make secrets-init       - Initialize secrets directory"
	@echo "  make secrets-generate   - Generate self-signed certificates (dev)"
	@echo "  make secrets-letsencrypt - Import Let's Encrypt certificates"
	@echo ""
	@echo "$(YELLOW)Build & Deploy:$(NC)"
	@echo "  make build              - Build all Docker images (optimized)"
	@echo "  make build-no-cache     - Build without cache"
	@echo "  make deploy             - Deploy to production"
	@echo "  make up                 - Start all services"
	@echo "  make down               - Stop all services"
	@echo "  make restart            - Restart all services"
	@echo ""
	@echo "$(YELLOW)Monitoring:$(NC)"
	@echo "  make status             - Show service status"
	@echo "  make health             - Check health of all services"
	@echo "  make logs               - Show logs from all services"
	@echo "  make logs-follow        - Follow logs in real-time"
	@echo "  make logs-service       - Show logs for specific service (make logs-service SERVICE=mail-rs)"
	@echo "  make stats              - Show resource usage"
	@echo ""
	@echo "$(YELLOW)Maintenance:$(NC)"
	@echo "  make backup             - Backup all data"
	@echo "  make restore            - Restore from backup"
	@echo "  make update             - Update all services to latest version"
	@echo "  make clean              - Remove all containers and volumes"
	@echo "  make prune              - Clean up Docker system"
	@echo ""
	@echo "$(YELLOW)User Management:$(NC)"
	@echo "  make add-user           - Add a new user interactively"
	@echo "  make list-users         - List all users"
	@echo ""
	@echo "$(YELLOW)Testing:$(NC)"
	@echo "  make test               - Run all tests"
	@echo "  make test-e2e           - Run E2E tests"
	@echo "  make test-integration   - Test with real email clients"
	@echo ""
	@echo "$(YELLOW)Security:$(NC)"
	@echo "  make security-scan      - Scan images for vulnerabilities"
	@echo "  make ssl-check          - Verify SSL/TLS certificates"
	@echo ""

# =============================================================================
# Setup
# =============================================================================

init:
	@echo "$(GREEN)Initializing production environment...$(NC)"
	@mkdir -p secrets data/{maildir,queue,db,backups} logs
	@chmod 700 secrets
	@if [ ! -f .env.prod ]; then \
		cp .env.prod.example .env.prod; \
		echo "$(YELLOW)Created .env.prod - please edit it with your configuration$(NC)"; \
	fi
	@echo "$(GREEN)Initialization complete!$(NC)"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Edit .env.prod with your configuration"
	@echo "  2. Run: make secrets-init"
	@echo "  3. Run: make secrets-generate (or secrets-letsencrypt for production)"
	@echo "  4. Run: make deploy"

secrets-init:
	@./scripts/manage-secrets.sh init

secrets-generate:
	@./scripts/manage-secrets.sh generate-self-signed

secrets-letsencrypt:
	@./scripts/manage-secrets.sh import-letsencrypt

secrets-verify:
	@./scripts/manage-secrets.sh verify

# =============================================================================
# Build & Deploy
# =============================================================================

build:
	@echo "$(GREEN)Building optimized Docker images...$(NC)"
	@DOCKER_BUILDKIT=1 $(COMPOSE) build \
		--build-arg VERSION=$(VERSION) \
		--build-arg BUILDKIT_INLINE_CACHE=1
	@echo "$(GREEN)Build complete!$(NC)"

build-no-cache:
	@echo "$(GREEN)Building without cache...$(NC)"
	@DOCKER_BUILDKIT=1 $(COMPOSE) build --no-cache \
		--build-arg VERSION=$(VERSION)

deploy: build
	@echo "$(GREEN)Deploying to production...$(NC)"
	@$(COMPOSE) up -d
	@echo ""
	@echo "$(GREEN)Waiting for services to be healthy...$(NC)"
	@sleep 5
	@$(MAKE) health
	@echo ""
	@echo "$(GREEN)Deployment complete!$(NC)"
	@echo "Services are running at:"
	@echo "  - SMTP:  localhost:25"
	@echo "  - IMAP:  localhost:143"
	@echo "  - Web:   https://$(shell grep MAIL_DOMAIN .env.prod 2>/dev/null | cut -d= -f2)"

up:
	@$(COMPOSE) up -d
	@echo "$(GREEN)Services started$(NC)"

down:
	@$(COMPOSE) down
	@echo "$(YELLOW)Services stopped$(NC)"

restart:
	@$(COMPOSE) restart
	@echo "$(GREEN)Services restarted$(NC)"

# =============================================================================
# Monitoring
# =============================================================================

status:
	@$(COMPOSE) ps

health:
	@echo "$(GREEN)Checking service health...$(NC)"
	@for service in mail-rs mcp-mail-server ai-runtime; do \
		echo -n "$$service: "; \
		status=$$(docker inspect --format='{{.State.Health.Status}}' gk-$$service 2>/dev/null || echo "not running"); \
		if [ "$$status" = "healthy" ]; then \
			echo "$(GREEN)✓ healthy$(NC)"; \
		elif [ "$$status" = "starting" ]; then \
			echo "$(YELLOW)⏳ starting$(NC)"; \
		else \
			echo "$(RED)✗ $$status$(NC)"; \
		fi; \
	done

logs:
	@$(COMPOSE) logs --tail=100

logs-follow:
	@$(COMPOSE) logs -f

logs-service:
ifndef SERVICE
	@echo "$(RED)Error: SERVICE not specified$(NC)"
	@echo "Usage: make logs-service SERVICE=mail-rs"
else
	@$(COMPOSE) logs $(SERVICE) --tail=100 -f
endif

stats:
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

# =============================================================================
# Maintenance
# =============================================================================

backup:
	@echo "$(GREEN)Creating backup...$(NC)"
	@BACKUP_DATE=$$(date +%Y%m%d_%H%M%S); \
	BACKUP_DIR="data/backups/backup_$$BACKUP_DATE"; \
	mkdir -p $$BACKUP_DIR; \
	docker exec gk-mail-rs sh -c "cd /data && tar czf - maildir db queue" > $$BACKUP_DIR/data.tar.gz; \
	docker exec gk-ollama sh -c "cd /root/.ollama && tar czf - ." > $$BACKUP_DIR/ollama.tar.gz 2>/dev/null || true; \
	echo "$(GREEN)Backup created at $$BACKUP_DIR$(NC)"

restore:
ifndef BACKUP
	@echo "$(RED)Error: BACKUP not specified$(NC)"
	@echo "Usage: make restore BACKUP=data/backups/backup_20231125_120000"
	@echo ""
	@echo "Available backups:"
	@ls -1 data/backups/ 2>/dev/null || echo "  (none)"
else
	@echo "$(YELLOW)Warning: This will restore data from $(BACKUP)$(NC)"
	@read -p "Continue? (yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		echo "$(GREEN)Restoring from backup...$(NC)"; \
		docker exec -i gk-mail-rs sh -c "cd /data && tar xzf -" < $(BACKUP)/data.tar.gz; \
		docker exec -i gk-ollama sh -c "cd /root/.ollama && tar xzf -" < $(BACKUP)/ollama.tar.gz 2>/dev/null || true; \
		echo "$(GREEN)Restore complete!$(NC)"; \
		echo "$(YELLOW)Restarting services...$(NC)"; \
		$(MAKE) restart; \
	else \
		echo "$(YELLOW)Cancelled$(NC)"; \
	fi
endif

update:
	@echo "$(GREEN)Updating services...$(NC)"
	@git pull
	@$(MAKE) build
	@$(COMPOSE) up -d
	@echo "$(GREEN)Update complete!$(NC)"

clean:
	@echo "$(RED)Warning: This will remove all containers and volumes$(NC)"
	@read -p "Are you sure? (yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		$(COMPOSE) down -v; \
		echo "$(GREEN)Cleanup complete!$(NC)"; \
	else \
		echo "$(YELLOW)Cancelled$(NC)"; \
	fi

prune:
	@echo "$(YELLOW)Cleaning up Docker system...$(NC)"
	@docker system prune -f
	@docker volume prune -f
	@echo "$(GREEN)System pruned!$(NC)"

# =============================================================================
# User Management
# =============================================================================

add-user:
	@read -p "Email: " email; \
	read -s -p "Password: " pass; \
	echo ""; \
	docker exec -it gk-mail-rs /app/mail-user -d sqlite:///data/db/users.db add $$email $$pass

list-users:
	@docker exec gk-mail-rs /app/mail-user -d sqlite:///data/db/users.db list

# =============================================================================
# Testing
# =============================================================================

test:
	@echo "$(GREEN)Running all tests...$(NC)"
	@cargo test --workspace --release

test-e2e:
	@echo "$(GREEN)Running E2E tests...$(NC)"
	@./run-e2e-tests.sh

test-integration:
	@echo "$(GREEN)Testing with Thunderbird/Apple Mail...$(NC)"
	@echo "SMTP: localhost:25"
	@echo "IMAP: localhost:143"
	@echo "Use these settings in your mail client"

# =============================================================================
# Security
# =============================================================================

security-scan:
	@echo "$(GREEN)Scanning images for vulnerabilities...$(NC)"
	@command -v trivy >/dev/null 2>&1 || { echo "$(YELLOW)Installing trivy...$(NC)"; brew install trivy || apt-get install trivy; }
	@for image in mail-rs mcp-mail-server ai-runtime proxy-rs; do \
		echo ""; \
		echo "$(GREEN)Scanning gk-$$image:latest...$(NC)"; \
		trivy image --severity HIGH,CRITICAL gk-$$image:latest; \
	done

ssl-check:
	@echo "$(GREEN)Verifying SSL/TLS certificates...$(NC)"
	@openssl s_client -connect localhost:2525 -starttls smtp -showcerts 2>/dev/null | openssl x509 -noout -dates
	@openssl x509 -in secrets/mail_tls_cert.pem -noout -dates 2>/dev/null || echo "$(YELLOW)Certificate not found$(NC)"

# =============================================================================
# Development helpers
# =============================================================================

shell-mail:
	@docker exec -it gk-mail-rs /bin/sh

shell-ai:
	@docker exec -it gk-ai-runtime /bin/sh

shell-mcp:
	@docker exec -it gk-mcp-mail /bin/sh

# =============================================================================
# Utilities
# =============================================================================

version:
	@echo "Version: $(VERSION)"

config:
	@$(COMPOSE) config

validate:
	@echo "$(GREEN)Validating configuration...$(NC)"
	@$(COMPOSE) config --quiet && echo "$(GREEN)✓ docker-compose.prod.yml is valid$(NC)" || echo "$(RED)✗ Invalid configuration$(NC)"
	@test -f .env.prod && echo "$(GREEN)✓ .env.prod exists$(NC)" || echo "$(YELLOW)⚠ .env.prod missing$(NC)"
	@test -d secrets && echo "$(GREEN)✓ secrets/ directory exists$(NC)" || echo "$(YELLOW)⚠ secrets/ missing$(NC)"
	@test -f secrets/mail_tls_cert.pem && echo "$(GREEN)✓ TLS certificates present$(NC)" || echo "$(RED)✗ TLS certificates missing$(NC)"
